name: Deploy to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy_client:
    environment: DEPLOY_KEY_KARTYAJATEK
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      # ğŸ“Œ 1ï¸âƒ£ Kliensek telepÃ­tÃ©se Ã©s buildelÃ©se
      - name: Install client dependencies
        run: cd client && npm install

      - name: Build the client project
        run: cd client && npm run build

      # ğŸ“Œ 2ï¸âƒ£ SSH kulcs beÃ¡llÃ­tÃ¡sa
      - name: Set up SSH for client deployment
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY_KARTYAJATEK }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # ğŸ“Œ 3ï¸âƒ£ Csak a client/dist mappÃ¡t mÃ¡solja fel a VPS-re
      - name: Deploy client dist to VPS
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" \
            ./client/dist/ \
            ubuntu@217.182.76.202:/home/ubuntu/kartyajatek/dist/

      # ğŸ“Œ 4ï¸âƒ£ Az alkalmazÃ¡s indÃ­tÃ¡sa PM2-vel (kliensek) a 3010-es porton
      - name: Restart client application with PM2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@217.182.76.202 << 'EOF'
            cd /home/ubuntu/kartyajatek
            pm2 delete kartyajatek_client || true
            pm2 start npx --name "kartyajatek_client" -- serve -s dist -l 3010
            pm2 save
          EOF

  deploy_server:
    environment: DEPLOY_KEY_KARTYAJATEK
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      # ğŸ“Œ 1ï¸âƒ£ Szerver fÃ¼ggÅ‘sÃ©gek telepÃ­tÃ©se
      - name: Install server dependencies
        run: cd server && npm install

      # ğŸ“Œ 2ï¸âƒ£ SSH kulcs beÃ¡llÃ­tÃ¡sa
      - name: Set up SSH for server deployment
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY_KARTYAJATEK }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # ğŸ“Œ 3ï¸âƒ£ A server mappa feltÃ¶ltÃ©se a VPS-re
      - name: Deploy server to VPS
        run: |
          rsync -avz --delete --exclude='ssl' --exclude='.env' \
            -e "ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i ~/.ssh/id_rsa" \
            ./server/ \
            ubuntu@217.182.76.202:/home/ubuntu/kartyajatek/server/

      # ğŸ“Œ 4ï¸âƒ£ A szerver alkalmazÃ¡s indÃ­tÃ¡sa/ÃºjraindÃ­tÃ¡sa PM2-vel
      - name: Restart server with PM2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@217.182.76.202 << 'EOF'
            cd /home/ubuntu/kartyajatek/server
            pm2 delete kartyajatek_server || true
            pm2 start npm --name "kartyajatek_server" -- start
            pm2 save
          EOF
